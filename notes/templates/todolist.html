{% extends "base.html" %}
{% block title %}
    ToDo List
{% endblock title %}
{% block header %}
    <br>
    {{ page }}
{% endblock header %}
{% block content %}
    {% comment %} {{ tasks }} {% endcomment %}
    {% comment %} <div class="container">
        {% for task in tasks %}<li>{{ task.task }} - {{ task.is_completed }}</li>{% endfor %}
    </div> {% endcomment %}
    <div class="container">
        <br>
        {% if messages %}
            {% for message in messages %}
                {% if 'error' in message.tags %}
                    <div class="alert alert-danger" role="alert">{{ message }}</div>
                {% elif 'success' in message.tags %}
                    <div class="alert alert-success" role="alert">{{ message }}</div>
                {% elif 'warning' in message.tags %}
                    <div class="alert alert-warning" role="alert">{{ message }}</div>
                {% else %}
                    <div class="alert alert-info" role="alert">{{ message }}</div>
                {% endif %}
            {% endfor %}
        {% endif %}
        <script>
            setTimeout(function() {
                document.querySelectorAll('.alert').forEach(alert => alert.remove());
            }, 3000);
        </script>
        <form method="post">
            {% comment %} This is a CSRF token used to keep the form save. It is an encryption method used to safeguard the form submission. {% endcomment %}
            {% csrf_token %}
            <div class="mb-3">
                <label for="add_new_task" class="form-label">Add a new task...</label>
                <input type="text"
                       class="form-control"
                       id="add_new_task"
                       placeholder="Add a new task..."
                       name="task">
                {% comment %}The name should be same as the field to be added in the table and refer models.py for the name of the field being operated{% endcomment %}
            </div>
            <button type="submit" class="btn btn-primary">Add Task</button>
        </form>
        <br>
        <table class="table table-striped table-hover table-bordered text-center align-middle">
            <thead class="table-dark">
                <tr>
                    <th scope="col">Sr. No.</th>
                    <th scope="col">Task</th>
                    <th scope="col">Status</th>
                    <th scope="col" colspan="2">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for task in tasks %}
                    <tr {% if task.is_completed %}
                            class="table-success"
                        {% else %}
                            class="table-danger"
                        {% endif %}>
                        <th scope="row">{{ forloop.counter }}</th>
                        <td>
                            <span class="task-text" id="task-text-{{ task.id }}">{{ task.task }}</span>
                            <input type="text"
                                   class="form-control task-input"
                                   id="task-input-{{ task.id }}"
                                   value="{{ task.task }}"
                                   style="display:none">
                        </td>
                        <td>
                            {% if task.is_completed %}
                                Completed
                            {% else %}
                                Not Completed
                            {% endif %}
                        </td>
                        <td>
                            <button type="button"
                                    class="btn btn-sm btn-outline-primary edit-btn"
                                    id="edit-btn-{{ task.id }}"
                                    onclick="enableEdit({{ task.id }});"
                                    title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     width="16"
                                     height="16"
                                     fill="currentColor"
                                     class="bi bi-pencil"
                                     viewBox="0 0 16 16">
                                    <path d="M12.146.292a.5.5 0 0 1 .708 0l2.854 2.854a.5.5 0 0 1 0 .708l-10.5 10.5a.5.5 0 0 1-.168.11l-5 1.5a.5.5 0 0 1-.65-.65l1.5-5a.5.5 0 0 1 .11-.168l10.5-10.5zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zM13.5 5.794 11.207 3.5 3.5 11.207v2.293h2.293l7.7-7.7z" />
                                </svg>
                            </button>
                            <button type="button"
                                    class="btn btn-sm btn-outline-success save-btn"
                                    id="save-btn-{{ task.id }}"
                                    onclick="saveEdit({{ task.id }});"
                                    style="display:none"
                                    title="Save">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     width="16"
                                     height="16"
                                     fill="currentColor"
                                     class="bi bi-check-circle"
                                     viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                                    <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z" />
                                </svg>
                            </button>
                            <button type="button"
                                    class="btn btn-sm btn-outline-danger cancel-btn"
                                    id="cancel-btn-{{ task.id }}"
                                    onclick="cancelEdit({{ task.id }});"
                                    style="display:none"
                                    title="Cancel">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     width="16"
                                     height="16"
                                     fill="currentColor"
                                     class="bi bi-x-circle"
                                     viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
                                </svg>
                            </button>
                        </td>
                        <td>
                            <a href="{% url 'delete_task' task.id %}"
                               class="text-danger"
                               title="Delete"
                               aria-label="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     width="16"
                                     height="16"
                                     fill="currentColor"
                                     class="bi bi-trash"
                                     viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z" />
                                    <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z" />
                                </svg>
                            </a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <script>
        function enableEdit(taskId) {
            document.getElementById(`task-text-${taskId}`).style.display = 'none';
            document.getElementById(`task-input-${taskId}`).style.display = 'block';
            document.getElementById(`edit-btn-${taskId}`).style.display = 'none';
            document.getElementById(`save-btn-${taskId}`).style.display = 'inline-block';
            document.getElementById(`cancel-btn-${taskId}`).style.display = 'inline-block';
            document.getElementById(`task-input-${taskId}`).focus();
        }

        function cancelEdit(taskId) {
            document.getElementById(`task-text-${taskId}`).style.display = 'inline';
            document.getElementById(`task-input-${taskId}`).style.display = 'none';
            document.getElementById(`edit-btn-${taskId}`).style.display = 'inline-block';
            document.getElementById(`save-btn-${taskId}`).style.display = 'none';
            document.getElementById(`cancel-btn-${taskId}`).style.display = 'none';
        }

        function saveEdit(taskId) {
            const newTaskText = document.getElementById(`task-input-${taskId}`).value;
            if (newTaskText.trim() === '') {
                alert('Task cannot be empty!');
                return;
            }
            // Send AJAX request to update the task
            fetch(`/edit_task/${taskId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        task: newTaskText
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById(`task-text-${taskId}`).innerText = newTaskText;
                        cancelEdit(taskId);
                        location.reload();
                    } else {
                        alert('Error updating task: ' + data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
{% endblock content %}
