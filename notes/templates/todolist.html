{% extends "base.html" %}
{% block title %}
    ToDo List
{% endblock title %}
{% block header %}
{% endblock header %}
{% block content %}
    {% comment %} Page header with gradient background {% endcomment %}
    <div class="page-header">
        <h2>
            <i class="bi bi-list-check"></i> Things To Do
        </h2>
    </div>
    <div class="container">
        {% comment %} Hidden messages - will be converted to toasts by JavaScript {% endcomment %}
        <div style="display: none;">
            {% if messages %}
                {% for message in messages %}
                    {% if 'error' in message.tags %}
                        <div class="alert alert-danger" role="alert">{{ message }}</div>
                    {% elif 'success' in message.tags %}
                        <div class="alert alert-success" role="alert">{{ message }}</div>
                    {% elif 'warning' in message.tags %}
                        <div class="alert alert-warning" role="alert">{{ message }}</div>
                    {% else %}
                        <div class="alert alert-info" role="alert">{{ message }}</div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>
        {% comment %} Form to add a new task - inline design {% endcomment %}
        <form method="post" class="add-task-form">
            {% comment %} This is a CSRF token used to keep the form safe. It is an encryption method used to safeguard the form submission. {% endcomment %}
            {% csrf_token %}
            <input type="text"
                   class="form-control"
                   id="add_new_task"
                   placeholder="Add a new task..."
                   name="task"
                   required>
            {% comment %} The name should be same as the field to be added in the table and refer models.py for the name of the field being operated {% endcomment %}
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Add Task
            </button>
        </form>
        {% comment %} Table container with improved styling {% endcomment %}
        <div class="table-container">
            <table class="table table-striped table-hover table-bordered text-center align-middle">
                <thead>
                    <tr>
                        <th scope="col" style="width: 8%;">Sr. No.</th>
                        <th scope="col" style="width: 50%;">Task</th>
                        <th scope="col" style="width: 15%;">Status</th>
                        <th scope="col" style="width: 17%;">Actions</th>
                        <th scope="col" style="width: 10%;">Delete</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                        {% comment %} Apply different row colors based on task completion status {% endcomment %}
                        <tr {% if task.is_completed %}
                                class="table-success"
                            {% else %}
                                class="table-danger"
                            {% endif %}>
                            {% comment %} Column 1: Serial Number {% endcomment %}
                            <th scope="row">{{ forloop.counter }}</th>
                            {% comment %} Column 2: Task with timestamp {% endcomment %}
                            <td class="text-start">
                                <div>
                                    <span class="task-text
                                                 {% if task.is_completed %}task-completed{% endif %}"
                                          id="task-text-{{ task.id }}">{{ task.task }}</span>
                                    <input type="text"
                                           class="form-control task-input"
                                           id="task-input-{{ task.id }}"
                                           value="{{ task.task }}"
                                           style="display:none">
                                    {% comment %} Timestamp in lower area of task cell {% endcomment %}
                                    <span class="task-timestamp">
                                        {% if task.updated_at and task.created_at %}
                                            {% comment %} Check if updated_at is different from created_at (task was edited) {% endcomment %}
                                            {% if task.updated_at|date:"Y-m-d H:i:s" != task.created_at|date:"Y-m-d H:i:s" %}
                                                <i class="bi bi-pencil-fill"></i> Updated: {{ task.updated_at|date:"d M Y, h:i A" }}
                                            {% else %}
                                                <i class="bi bi-calendar-plus"></i> Created: {{ task.created_at|date:"d M Y, h:i A" }}
                                            {% endif %}
                                        {% elif task.created_at %}
                                            <i class="bi bi-calendar-plus"></i> Created: {{ task.created_at|date:"d M Y, h:i A" }}
                                        {% endif %}
                                    </span>
                                </div>
                            </td>
                            {% comment %} Column 3: Status with checkbox {% endcomment %}
                            <td>
                                <div class="form-check d-flex justify-content-center align-items-center">
                                    <input class="form-check-input task-checkbox"
                                           type="checkbox"
                                           id="checkbox-{{ task.id }}"
                                           {% if task.is_completed %}checked{% endif %}
                                           onchange="toggleTask({{ task.id }}, this)">
                                    <label class="form-check-label ms-2" for="checkbox-{{ task.id }}">
                                        <span class="badge status-badge
                                                     {% if task.is_completed %}
                                                         bg-success
                                                     {% else %}
                                                         bg-danger
                                                     {% endif %}">
                                            {% if task.is_completed %}
                                                Completed
                                            {% else %}
                                                Not Completed
                                            {% endif %}
                                        </span>
                                    </label>
                                </div>
                            </td>
                            {% comment %} Column 4: Actions (Edit/Save/Cancel buttons) {% endcomment %}
                            <td>
                                <button type="button"
                                        class="btn btn-sm btn-outline-primary edit-btn"
                                        id="edit-btn-{{ task.id }}"
                                        onclick="enableEdit({{ task.id }});"
                                        title="Edit Task">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button type="button"
                                        class="btn btn-sm btn-outline-success save-btn"
                                        id="save-btn-{{ task.id }}"
                                        onclick="saveEdit({{ task.id }});"
                                        style="display:none"
                                        title="Save Changes">
                                    <i class="bi bi-check-circle"></i> Save
                                </button>
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger cancel-btn"
                                        id="cancel-btn-{{ task.id }}"
                                        onclick="cancelEdit({{ task.id }});"
                                        style="display:none"
                                        title="Cancel Editing">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </button>
                            </td>
                            {% comment %} Column 5: Delete button {% endcomment %}
                            <td>
                                <a href="{% url 'delete_task' task.id %}"
                                   class="btn btn-sm btn-outline-danger"
                                   title="Delete Task"
                                   aria-label="Delete"
                                   onclick="return confirmDelete('{% url 'delete_task' task.id %}', '{{ task.task|escapejs }}');">
                                    <i class="bi bi-trash"></i> Delete
                                </a>
                            </td>
                        </tr>
                    {% empty %}
                        {% comment %} Display message when no tasks are available {% endcomment %}
                        <tr>
                            <td colspan="5" class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p class="mb-0">No tasks available. Add a new task to get started!</p>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% comment %} Toast container will be added dynamically by JavaScript {% endcomment %}
{% endblock content %}
